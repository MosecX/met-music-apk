name: Build MetMusic APK and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    
    steps:
      # 1. Checkout del cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Setup Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 5. Obtener versiÃ³n del package.json
      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ VersiÃ³n: $VERSION"

      # 6. Instalar dependencias
      - name: Install dependencies
        run: npm ci

      # 7. Expo doctor
      - name: Run expo doctor
        run: npx expo-doctor || true

      # 8. ACTUALIZAR VERSIONCODE con el nÃºmero del workflow
      - name: Update versionCode
        run: |
          jq '.expo.android.versionCode = ${{ github.run_number }}' app.json > app.tmp.json
          mv app.tmp.json app.json
          echo "âœ… versionCode actualizado a ${{ github.run_number }}"

      # 9. Prebuild
      - name: Expo prebuild
        run: npx expo prebuild --clean

      # 10. Cache de Gradle
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 11. Make gradlew executable
      - name: Make gradlew executable
        run: cd android && chmod +x gradlew

      # 12. CREAR KEYSTORE desde secrets
      - name: Create keystore from secrets
        run: |
          echo "${{ secrets.KEY_STORE }}" | base64 -d > keystore.jks
          echo "âœ… Keystore creado desde secrets"

      # 13. CONFIGURAR FIRMA en build.gradle (CORREGIDO)
      - name: Configure signing
        run: |
          # Agregar configuraciÃ³n de firma al final de build.gradle
          cat >> android/app/build.gradle << 'EOF'
          
          android {
              signingConfigs {
                  release {
                      storeFile file('../../keystore.jks')
                      storePassword "${{ secrets.KEY_STORE_PASS }}"
                      keyAlias "${{ secrets.KEY_ALIAS }}"
                      keyPassword "${{ secrets.KEY_PASS }}"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF
          echo "âœ… Firma configurada en build.gradle"

      # 14. BUILD FIRMADO
      - name: Build signed release APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace

      # 15. ENCONTRAR y preparar el APK
      - name: Prepare APK for release
        id: prepare_apk
        run: |
          # Buscar el APK (ahora serÃ¡ app-release.apk)
          APK_PATH=$(find android/app/build/outputs -name "*.apk" | head -n 1)
          echo "ðŸ“ APK encontrado en: $APK_PATH"
          
          # Crear nombre para el release
          DATE=$(date +'%Y%m%d')
          APK_NAME="MetMusic-v${{ steps.version.outputs.version }}-build${{ github.run_number }}.apk"
          
          # Copiar a la raÃ­z con nombre legible
          cp "$APK_PATH" "./$APK_NAME"
          echo "ðŸ“¦ APK preparado: $APK_NAME"
          
          # Guardar variables
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_path=./$APK_NAME" >> $GITHUB_OUTPUT

      # 16. Crear Tag (si no existe)
      - name: Create Tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          TAG_NAME="v${{ steps.version.outputs.version }}"
          git tag -f $TAG_NAME
          git push origin $TAG_NAME --force
        continue-on-error: true

      # 17. Crear Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: MetMusic v${{ steps.version.outputs.version }}
          body: |
            ## ðŸŽµ MetMusic v${{ steps.version.outputs.version }}
            
            ### âœ… Cambios en esta versiÃ³n:
            - Build: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            
            ### ðŸ“± InstalaciÃ³n:
            1. Descarga el APK
            2. Permite instalaciÃ³n de orÃ­genes desconocidos
            3. Instala y disfruta ðŸŽ§
            
            ### ðŸ”§ Detalles tÃ©cnicos:
            - Fecha: $(date +'%d/%m/%Y %H:%M')
            - versionCode: ${{ github.run_number }}
            - **APK FIRMADO**: âœ… Puedes actualizar sin desinstalar
          files: ${{ steps.prepare_apk.outputs.apk_path }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 18. VerificaciÃ³n final
      - name: Show result
        run: |
          echo "ðŸŽ‰ Â¡RELEASE COMPLETADO!"
          echo "ðŸ“± APK firmado subido: ${{ steps.prepare_apk.outputs.apk_name }}"
          echo "ðŸ”— Ver release en:"
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"


